{% extends "nbhosting.html" %}

{% block title %}
Stats for course {{course}}
{% endblock %}

{% block content %}
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href='/nbh/'>home</a></li>
  <li class="breadcrumb-item"><a href='/nbh/courses'>courses</a></li>
  <li class="breadcrumb-item active">{{course}} stats</li>
</ol>



<!-- avoid the symlink to use the latest one in production
  -- but quite useful for adopting the latest one 
  -- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
<script src="https://cdn.plot.ly/plotly-1.25.2.min.js"></script>

<div class="card">
<div class="card-block">
<h1 class="card-title card-header">Progression</h1>
<!-- students -->
<h2 class="card-title card-header">Students - who showed up at least once</h2>
<div  id="stats-students"></div>
<span id="legend-students"></span>
<!-- notebooks -->
<h2 class="card-title card-header">Notebooks - read at least once</h2>
<div  id="stats-notebooks"></div>
<span id="legend-notebooks"></span>
</div>
</div>

<hr/ >
<div class="card">
<div class="card-block">
<h1 class="card-title card-header">Activity</h1>
<!-- jupyter containers -->
<h2 class="card-title card-header">Jupyter containers</h2>
<div  id="stats-jupyters"></div>
<span id="legend-jupyters"></span>
</div>
<div class="card-block">
<h2 class="card-title card-header">Running kernels / kernels</h2>
<div  id="stats-kernels"></div>
<span id="legend-kernels"></span>
</div>
<div class="card-block">
<h2 class="card-title card-header">Students with homedirs</h2>
<div  id="stats-student-counts"></div>
<span id="legend-student-counts"></span>
</div>
</div>

<hr/ >
<div class="card">
<div class="card-block">
<h1 class="card-title card-header">Disk space</h1>
<!-- percentage -->
<h2 class="card-title card-header">Percentage</h2>
<div  id="stats-ds-percent"></div>
<span id="legend-ds-percent"></span>
</div>
<div class="card-block">
<h2 class="card-title card-header">Free Space</h2>
<div  id="stats-ds-free"></div>
<span id="legend-ds-free"></span>
</div>
</div>

<hr/ >
<div class="card">
<div class="card-block">
<h1 class="card-title card-header">CPU load</h1>
<!-- percentage -->
<h2 class="card-title card-header">Loads</h2>
<div  id="stats-cpu-load"></div>
<span id="legend-cpu-load"></span>
</div>
</div>

<!-- end -->

<script>
var url_metrics="/nbh/stats/daily_metrics/{{course}}";
d3.request(url_metrics, function (error, response) {
    var incoming = JSON.parse(response.response);
    console.log("from daily_metrics");
    console.log(incoming);
    // incoming parts
    var d_timestamps     = incoming['daily']['timestamps'];
    var e_timestamps     = incoming['events']['timestamps'];
    var d_new_students   = incoming['daily']['new_students'];
    var d_uni_students   = incoming['daily']['unique_students'];
    var e_total_students = incoming['events']['total_students'];
    var d_new_notebooks   = incoming['daily']['new_notebooks'];
    var d_uni_notebooks   = incoming['daily']['unique_notebooks'];
    var e_total_notebooks = incoming['events']['total_notebooks'];

    var layout = {'legend' :
		  { 'orientation' : 'h',
		    'x' : -.1, 'y': 1.2}};

    var new_students_data =   { 'x' : d_timestamps, 'y' : d_new_students,
			        'name': 'new students / day'};
    var uni_students_data =   { 'x' : d_timestamps, 'y' : d_uni_students,
			        'name': 'unique students / day'};
    var total_students_data = { 'x' : e_timestamps, 'y' : e_total_students,
				'name': 'total students'};
    Plotly.newPlot('stats-students',
		   [uni_students_data, new_students_data, total_students_data],
		   layout);

    var new_notebooks_data =   { 'x' : d_timestamps, 'y' : d_new_notebooks,
			         'name': 'new notebooks / day'};
    var uni_notebooks_data =   { 'x' : d_timestamps, 'y' : d_uni_notebooks,
			         'name': 'unique notebooks open / day'};
    var total_notebooks_data = { 'x' : e_timestamps, 'y' : e_total_notebooks,
    			       	 'name': 'notebooks read at least once'};
    Plotly.newPlot('stats-notebooks',
		   [ uni_notebooks_data, new_notebooks_data, total_notebooks_data],
		   layout);
});
var url_counts="/nbh/stats/monitor_counts/{{course}}";
d3.request(url_counts, function (error, response) {
    var incoming = JSON.parse(response.response);
    console.log("from monitor counts");
    console.log(incoming);

    // incoming parts
    var timestamps  = incoming['timestamps'];
    var running_jupyters = incoming['running_jupyters'];
    var	total_jupyters = incoming['total_jupyters'];
    var running_kernels = incoming['running_kernels'];
    var student_counts = incoming['student_counts'];
    var ds_percents = incoming['ds_percents'];
    var ds_frees = incoming['ds_frees'];
    var loads1 = incoming['loads1'];
    var loads2 = incoming['loads2'];
    var loads3 = incoming['loads3'];

    var layout = {'legend' :
		  { 'orientation' : 'h',
		    'x' : -.1, 'y': 1.2}};

    var running_jupyters_data = {
	'x' : timestamps, 'y' : running_jupyters,
	'name' : "running jupyter containers",
    };
    var total_jupyters_data = {
	'x' : timestamps, 'y' : total_jupyters,
	'name' : "total jupyter containers",
    };
    Plotly.newPlot('stats-jupyters', [running_jupyters_data,
				      total_jupyters_data],
				      layout);
    var running_kernels_data = {
	'x' : timestamps, 'y' : running_kernels,
	'name' : "running kernels"
    }
    Plotly.newPlot('stats-kernels',
		   [running_kernels_data],
		   layout);

    var student_counts_data = {
        'x': timestamps, 'y' : student_counts,
        'name' : "students found with a homedir"
    }
    Plotly.newPlot('stats-student-counts',
		   [student_counts_data],
		  layout);

    var ds_percents_data = {
        'x': timestamps, 'y': ds_percents,
        'name' : 'percentage of free disk space',
    }
    var layout_100 = JSON.parse(JSON.stringify(layout));
    layout_100['yaxis'] = {'range' : [0, 100]};
    Plotly.newPlot('stats-ds-percent',
                   [ds_percents_data],
		   layout_100);
    
    var ds_frees_data = {
        'x': timestamps, 'y': ds_frees,
        'name' : 'freeage of free disk space',
    }
    Plotly.newPlot('stats-ds-free',
                   [ds_frees_data],
		   layout);
    
    var loads1_data = {
        'x': timestamps, 'y': loads1,
        'name' : 'uptime(1)',
    }
    var loads2_data = {
        'x': timestamps, 'y': loads2,
        'name' : 'uptime(2)',
    }
    var loads3_data = {
        'x': timestamps, 'y': loads3,
        'name' : 'uptime(3)',
    }
    Plotly.newPlot('stats-cpu-load',
                   [loads1_data, loads2_data, loads3_data],
		   layout);
    
});
</script>
{% endblock %}
