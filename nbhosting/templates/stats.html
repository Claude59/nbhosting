{% extends "nbhosting.html" %}

{% block head_title %}
{{course}} stats
{% endblock %}

{% block title %}
Stats for course {{course}}
{% endblock %}

{% block content %}
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href='/nbh/'>home</a></li>
  <li class="breadcrumb-item"><a href='/nbh/courses'>courses</a></li>
  <li class="breadcrumb-item active">{{course}} stats</li>
</ol>

<div class="card">
<div class="card-block">
<button type="button" class="btn btn-outline-danger">Warning: all times are UTC</button>
<button type="button" class="btn btn-outline-success" id='show-all'>Show all</button>
<button type="button" class="btn btn-outline-primary" id='hide-all'>Hide all</button>
</div>
</div>

<!-- avoid the symlink in production
  -- but quite useful for adopting the latest one 
  -- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
<script src="https://cdn.plot.ly/plotly-1.25.2.min.js"></script>

<!-- html scafolding is based on 'sections' as defined in views.py -->
{% for section in sections %}
<div class='card'>
<h1 class='card-title card-header'>
{{section.title}}</h1>
<div class="card-block" id='{{section.id}}'>
{% for subsection in section.subsections %}
<h2 class='card-title card-header' data-toggle='collapse' data-target='#{{subsection.plotly_name}}'>
{{subsection.title}}</h2>
<div id='{{subsection.plotly_name}}' class='collapse'></div>
{% endfor %}
</div>
</div>
{% endfor %}

<!---------------------->
<script>
function show_all_collapse() {
    $(".collapse").collapse('show');
}
function hide_all_collapse() {
    $(".collapse").collapse('hide');
}
$(show_all_collapse);
$("#show-all").click(show_all_collapse);
$("#hide-all").click(hide_all_collapse);
var url_metrics="/nbh/stats/daily_metrics/{{course}}";
d3.request(url_metrics, function (error, response) {
    var incoming = JSON.parse(response.response);
    console.log("from daily_metrics");
    console.log(incoming);
    // incoming parts
    var d_timestamps     = incoming['daily']['timestamps'];
    var e_timestamps     = incoming['events']['timestamps'];
    var d_new_students   = incoming['daily']['new_students'];
    var d_uni_students   = incoming['daily']['unique_students'];
    var e_total_students = incoming['events']['total_students'];
    var d_new_notebooks   = incoming['daily']['new_notebooks'];
    var d_uni_notebooks   = incoming['daily']['unique_notebooks'];
    var e_total_notebooks = incoming['events']['total_notebooks'];

    var layout = {'legend' :
		  { 'orientation' : 'h',
		    'x' : -.1, 'y': 1.2}};

    var new_students_data =   { 'x' : d_timestamps, 'y' : d_new_students,
			        'name': 'new students / day'};
    var uni_students_data =   { 'x' : d_timestamps, 'y' : d_uni_students,
			        'name': 'unique students / day'};
    var total_students_data = { 'x' : e_timestamps, 'y' : e_total_students,
				'name': 'total students'};
    Plotly.newPlot('stats-students',
		   [uni_students_data, new_students_data, total_students_data],
		   layout);

    var new_notebooks_data =   { 'x' : d_timestamps, 'y' : d_new_notebooks,
			         'name': 'new notebooks / day'};
    var uni_notebooks_data =   { 'x' : d_timestamps, 'y' : d_uni_notebooks,
			         'name': 'unique notebooks open / day'};
    var total_notebooks_data = { 'x' : e_timestamps, 'y' : e_total_notebooks,
    			       	 'name': 'notebooks read at least once'};
    Plotly.newPlot('stats-notebooks',
		   [ uni_notebooks_data, new_notebooks_data, total_notebooks_data],
		   layout);
});
var url_counts="/nbh/stats/monitor_counts/{{course}}";
d3.request(url_counts, function (error, response) {
    var incoming = JSON.parse(response.response);
    console.log("from monitor counts");
    console.log(incoming);

    // incoming parts
    var timestamps  = incoming['timestamps'];
    var running_jupyters = incoming['running_jupyters'];
    var	total_jupyters = incoming['total_jupyters'];
    var running_kernels = incoming['running_kernels'];
    var student_counts = incoming['student_counts'];
    var ds_percents = incoming['ds_percents'];
    var ds_frees = incoming['ds_frees'];
    var load1s = incoming['load1s'];
    var load5s = incoming['load5s'];
    var load15s = incoming['load15s'];

    var layout = {'legend' :
		  { 'orientation' : 'h',
		    'x' : -.1, 'y': 1.2}};

    var running_jupyters_data = {
	'x' : timestamps, 'y' : running_jupyters,
	'name' : "running jupyter containers",
    };
    var total_jupyters_data = {
	'x' : timestamps, 'y' : total_jupyters,
	'name' : "total jupyter containers",
    };
    Plotly.newPlot('stats-jupyters', [running_jupyters_data,
				      total_jupyters_data],
				      layout);
    var running_kernels_data = {
	'x' : timestamps, 'y' : running_kernels,
	'name' : "running kernels"
    }
    Plotly.newPlot('stats-kernels',
		   [running_kernels_data],
		   layout);

    var student_counts_data = {
        'x': timestamps, 'y' : student_counts,
        'name' : "students found with a homedir"
    }
    Plotly.newPlot('stats-student-counts',
		   [student_counts_data],
		  layout);

    var ds_percents_data = {
        'x': timestamps, 'y': ds_percents,
        'name' : 'percentage of free disk space',
    }
    var layout_100 = JSON.parse(JSON.stringify(layout));
    layout_100['yaxis'] = {'range' : [0, 100]};
    Plotly.newPlot('stats-ds-percent',
                   [ds_percents_data],
		   layout_100);
    
    var ds_frees_data = {
        'x': timestamps, 'y': ds_frees,
        'name' : 'free disk space in MiB',
    }
    Plotly.newPlot('stats-ds-free',
                   [ds_frees_data],
		   layout);
    
    var load1s_data = {
        'x': timestamps, 'y': load1s,
        'name' : '100 x load past 1 minute',
    }
    var load5s_data = {
        'x': timestamps, 'y': load5s,
        'name' : '100 x load past 5 minutes',
    }
    var load15s_data = {
        'x': timestamps, 'y': load15s,
        'name' : '100 x load past 15 minutes',
    }
    Plotly.newPlot('stats-cpu-load',
                   [load1s_data, load5s_data, load15s_data],
		   layout);
    
});
</script>
{% endblock %}
